# ComfyUI 图像与视频目录加载保存节点

一套完整的 ComfyUI 自定义节点，用于批量处理图像和视频，支持目录加载、视频分割、自动合并等功能，特别适合长视频分段处理和批量图像处理工作流。

## 📦 节点列表

### 图像处理节点

1. **图像目录加载器** - 批量加载目录中的图像，支持递归搜索、自动索引和智能跳过
2. **图像目录保存器** - 批量保存图像到目录，保持原始路径结构
3. **图像保存与预览** - 保存图像并提供预览功能，支持单张和批量保存
4. **条件图像保存器** - 根据布尔条件将图像保存到不同目录

### 视频处理节点

5. **视频目录加载器** - 批量加载目录中的视频，支持音频提取和自动索引
6. **视频转换分割器** - 转换视频格式并按时间分割，支持GPU加速
7. **视频自动合并器** - 自动保存视频并在达到指定数量后合并

## 🎯 主要功能

### ✨ 核心特性

- **批量图像处理** - 支持目录级别的批量图像加载和保存
- **批量视频处理** - 支持目录级别的批量视频加载、分割和合并
- **格式转换** - 自动转换视频格式（AVI/WMV/MKV → MP4）
- **智能分割** - 基于关键帧的精确视频分割
- **自动合并** - 达到指定数量后自动合并视频
- **GPU 加速** - 自动检测并使用 NVIDIA GPU 加速
- **音频处理** - 完整的音频提取和合并功能
- **单次运行** - 批量处理时避免重复执行
- **智能重试** - 自动检测并修复关键帧问题
- **图像验证** - 自动检测和跳过空图像、占位图像

### 🚀 高级功能

- **VFR → CFR 转换** - 可变帧率转恒定帧率
- **关键帧插入** - 精确控制分割点
- **帧率调整** - 降低视频帧率
- **原音频保留** - 避免音频切割和多次编码
- **独立运行模式** - 直接合并目录中的视频
- **居中裁剪** - 统一分辨率时无黑边
- **自动重命名** - 避免文件覆盖
- **条件保存** - 根据布尔条件将图像保存到不同目录
- **自动索引** - 批量处理时自动记住处理位置
- **递归搜索** - 支持在子目录中递归搜索文件
- **格式过滤** - 支持按文件扩展名过滤文件

## 📖 详细文档

**📚 文档导航：**
- **[快速开始](docs/快速开始.md)** - 5分钟上手指南
- **[文档索引](docs/文档索引.md)** - 完整文档导航
- **[文件结构说明](docs/文件结构说明.md)** - 插件文件结构

### 核心功能文档

- **[智能关键帧检测说明](docs/智能关键帧检测说明.md)** - 自动检测和修复关键帧问题
- **[原音频处理功能说明](docs/原音频处理功能说明.md)** - 完整音频处理流程
- **[视频自动合并器独立运行说明](docs/视频自动合并器独立运行说明.md)** - 独立合并模式
- **[音频优先级说明](docs/音频优先级说明.md)** - 音频输入优先级规则

### 新功能说明

#### 📋 保存元数据功能

**功能说明：**
- **默认开启** - 新创建的节点默认开启元数据保存
- **自动格式切换** - 开启时自动切换为PNG格式
- **完整工作流保存** - 包含所有节点参数、种子值、模型信息
- **A1111 风格参数** - 保存工作流中的A1111风格参数
- **提示词信息** - 完整保存提示词和负面提示词

**保存的元数据内容：**
- **基础信息**：软件名称、创建时间、节点类型
- **工作流提示词**：完整的提示词和负面提示词
- **完整工作流**：所有节点的参数配置
- **种子值**：所有随机种子值
- **模型信息**：使用的模型名称和路径
- **A1111 参数**：如果工作流中包含相关节点

**使用方法：**
1. 在保存器节点中开启 **保存元数据** 开关
2. 正常运行工作流
3. 保存的PNG图像将包含完整工作流信息

#### 🖱️ 浏览目录按钮

**功能说明：**
- **一键打开资源管理器** - 点击按钮直接打开文件选择对话框
- **跨平台支持** - 支持Windows、Linux、macOS
- **自动填充路径** - 选择后自动填充到输入框
- **支持目录和文件** - 可选择目录或单个文件

**支持的节点：**
- ✅ 图像目录加载器
- ✅ 视频目录加载器
- ✅ 图像目录保存器
- ✅ 图像保存与预览器

### 功能说明文档

- **[GPU加速说明](docs/GPU加速说明.md)** - GPU 加速配置和使用
- **[单次运行功能说明](docs/单次运行功能说明.md)** - 批量处理优化
- **[VFR转CFR功能说明](docs/VFR转CFR功能说明.md)** - 帧率转换详解
- **[插入关键帧开关与体积优化说明](docs/插入关键帧开关与体积优化说明.md)** - 关键帧和体积优化
- **[视频分割优化说明](docs/视频分割优化说明.md)** - 分割命令优化
- **[视频合并器更新说明](docs/视频合并器更新说明.md)** - 合并器功能更新
- **[裁剪模式对比](docs/裁剪模式对比.md)** - Pad vs Crop 模式对比

### 问题分析文档

- **[帧率问题深度分析](docs/帧率问题深度分析.md)** - 帧率不一致问题分析
- **[WMV音频处理流程说明](docs/WMV音频处理流程说明.md)** - WMV 格式特殊处理
- **[音频处理说明](docs/音频处理说明.md)** - 音频处理详细说明
- **[同名文件处理快速指南](docs/同名文件处理快速指南.md)** - 文件重名处理

### 工具脚本

- **[检查关键帧.py](检查关键帧.py)** - 检查视频关键帧分布
- **[检查视频帧率.py](检查视频帧率.py)** - 检查视频帧率信息
- **[GPU加速快速指南](docs/GPU加速快速指南.md)** - GPU 快速配置指南

## 🎬 使用示例

### 示例工作流文件

我们提供了完整的示例工作流文件，可直接在ComfyUI中加载使用：

1. **[图像批量处理工作流](example_image_workflow.json)** - 展示图像目录加载、处理和条件保存的完整流程
2. **[视频批量处理工作流](example_video_workflow.json)** - 展示视频分割、处理和自动合并的完整流程

**使用方法：**
1. 下载或复制示例工作流文件到ComfyUI工作流目录
2. 在ComfyUI中点击「Load」按钮加载工作流
3. 根据需要修改参数（如输入输出路径）
4. 运行工作流开始处理

### 示例1：长视频分段处理

```
工作流:
[视频转换分割器]
    ├→ 输出目录 → [视频目录加载器] → [处理] → [视频自动合并器]
    ├→ 原文件名 ────────────────────────────→ [视频自动合并器]
    └→ 原音频路径 ──────────────────────────→ [视频自动合并器]

配置:
- 片段时间: 10 秒
- VFR转CFR: ✅ 开启
- 插入关键帧: ❌ 关闭（让智能检测决定）
- 触发合并数量: 999

结果:
- 自动分割长视频
- 逐段处理
- 自动合并为完整视频
- 音频保持完整
```

### 示例2：批量视频处理

```
工作流:
[图像目录加载器] → [处理] → [视频自动合并器]

配置:
- 单次运行: ✅ 开启
- 触发合并数量: 10

结果:
- 批量处理10个视频
- 只运行一次（不重复）
- 自动合并为1个视频
```

### 示例3：独立合并视频

```
工作流:
[视频自动合并器]
- 独立运行模式: ✅ 开启
- 触发合并数量: 10

操作:
1. 手动放置10个视频到待合并目录
2. 运行节点
3. 自动统一格式并合并

结果:
- 自动统一分辨率和帧率
- 合并为1个视频
- 保留原文件
```

## ⚙️ 节点详细说明

### 1. 图像目录加载器

**功能：** 批量加载目录中的图像文件，支持自动索引和智能跳过

**参数：**
- `目录路径` - 图像目录路径，支持相对路径（基于ComfyUI根目录）和绝对路径
- `起始索引` - 从第几张开始加载（0表示第1张），常用于分批加载或断点续传
- `任务批次编号` - 任务批次标识符，用于区分不同的加载任务
- `sort_method` - 排序方式：按名称、按数字、按修改时间
- `递归搜索子目录` - 是否在子目录中递归搜索图像文件
- `文件扩展名过滤` - 用逗号分隔的文件扩展名列表，留空则加载所有支持格式
- `加载失败跳过` - 遇到无法读取的图像文件时是否自动跳过
- `转换为RGBA` - 是否将图像转换为RGBA格式并添加透明通道

**UI功能：**
- **浏览目录按钮** - 点击打开文件资源管理器选择目录

**输出：**
- `图像` - 加载的图像张量
- `相对路径` - 相对路径列表
- `filename_text` - 当前文件名
- `可用总数` - 目录中可用图像总数
- `剩余未处理` - 剩余待处理图像数量

**特点：**
- 支持中文路径和相对路径
- 自动索引功能，批量处理时记住处理位置
- 智能跳过空图像和占位图像
- 支持多种图像格式：jpg、jpeg、png、bmp、webp、tiff
- 支持递归搜索子目录
- 自动检测并跳过无效图像文件

### 2. 图像目录保存器

**功能：** 批量保存图像到目录，保持原始相对路径结构

**参数：**
- `图像批量` - 要保存的批量图像数据，可以是单张或多张图像
- `输出目录` - 图像文件的保存目录路径
- `覆盖已存在文件` - 当目标位置已存在同名文件时是否覆盖
- `保存格式` - 保存格式：原格式、jpg、png、webp
- `JPG_WEBP_压缩质量` - JPG和WEBP格式的压缩质量（1-100），PNG格式无效
- `保存元数据` - 是否保存ComfyUI工作流元数据（默认：开启），开启后自动使用PNG格式

**可选参数：**
- `相对路径列表` - 可选的相对路径列表，连接时将保持原始目录结构保存
- `prompt` - 工作流提示词信息（自动传入）
- `extra_pnginfo` - 额外的PNG信息，包含完整工作流数据（自动传入）

**UI功能：**
- **浏览目录按钮** - 点击打开文件资源管理器选择目录

**特点：**
- 支持批量保存和单张保存
- 保持原始路径结构（当连接相对路径列表时）
- 自动创建目标目录
- 智能跳过无效图像和占位图像
- 支持多种图像格式，压缩质量可调节
- 自动生成序号文件名（当未连接相对路径列表时）

### 3. 图像保存与预览

**功能：** 保存图像到指定路径并提供预览功能，支持批量保存视频帧序列和单张图像

**参数：**
- `图像` - 要保存的单张或批量图像数据
- `保存路径` - 图像文件的保存目录路径
- `覆盖已存在文件` - 当目标位置已存在同名文件时是否覆盖
- `保存格式` - 保存格式：原格式、jpg、png、webp
- `压缩质量` - JPG和WEBP格式的压缩质量（1-100），PNG格式无效
- `保存元数据` - 是否保存ComfyUI工作流元数据（默认：开启），开启后自动使用PNG格式

**可选参数：**
- `filename_text` - 从加载图像节点连接的文件名文本
- `prompt` - 工作流提示词信息（自动传入）
- `extra_pnginfo` - 额外的PNG信息，包含完整工作流数据（自动传入）

**UI功能：**
- **浏览目录按钮** - 点击打开文件资源管理器选择目录

**输出：**
- `预览图像` - 返回第一帧作为预览图像
- `保存路径` - 实际保存的目录路径
- `保存数量` - 成功保存的图像数量

**特点：**
- 支持单张图像和批量视频帧保存
- 自动检测并跳过无效图像
- 自动生成唯一文件名，避免覆盖
- 提供实时预览功能
- 支持多种图像格式

### 4. 条件图像保存器

**功能：** 根据布尔条件将图像分类保存到不同目录

**参数：**
- `图像` - 要条件性保存的图像数据
- `条件` - 布尔条件判断（True=无水印，False=有水印）
- `启用分类保存` - 是否启用分类保存功能
- `基础保存路径` - 图像保存的基础目录路径
- `True时子目录` - 当条件为True时图像保存的子目录名称
- `False时子目录` - 当条件为False时图像保存的子目录名称
- `False时遮罩子目录` - 当条件为False时遮罩保存的子目录名称
- `覆盖已存在文件` - 当目标位置已存在同名文件时是否覆盖
- `保存格式` - 保存格式：原格式、jpg、png、webp
- `压缩质量` - JPG和WEBP格式的压缩质量（1-100），PNG格式无效

**可选参数：**
- `filename_text` - 从加载图像节点连接的文件名文本

**特点：**
- 基于布尔条件的智能分类保存
- 支持启用/禁用保存功能
- 灵活的子目录命名规则
- 自动生成唯一文件名
- 智能跳过无效图像

### 5. 视频目录加载器

**功能：** 批量加载目录中的视频文件

**参数：**
- `目录路径` - 视频目录路径
- `起始索引` - 从第几个开始加载（默认0）
- `加载数量` - 加载多少个（0=全部）
- `按短边缩放` - 缩放尺寸（0=不缩放）

**UI功能：**
- **浏览目录按钮** - 点击打开文件资源管理器选择目录

**输出：**
- `帧序列` - 视频帧张量
- `帧率` - 视频帧率
- `音频` - 音频数据
- `文件名` - 当前文件名

**特点：**
- 支持多种视频格式
- 自动提取音频
- 支持缩放

### 6. 视频转换分割器

**功能：** 转换视频格式并按时间分割

**参数：**
- `视频路径` - 输入视频路径
- `输出目录` - 输出目录路径
- `片段时间` - 每段时长（秒）
- `转换为MP4` - 是否转换为 MP4
- `VFR转CFR` - 转换为恒定帧率（推荐）
- `插入关键帧` - 插入关键帧以精确分割
- `降低帧率` - 目标帧率（0=不改变）
- `单次运行` - 批量处理时只运行一次

**输出：**
- `输出目录` - 分割后的目录路径
- `分割数量` - 分割的片段数量
- `原视频帧率` - 原视频帧率
- `原文件名` - 原文件名（不含扩展名）
- `原音频路径` - 提取的音频文件路径

**特点：**
- 智能关键帧检测（自动重试）
- GPU 加速支持
- 音频自动提取
- 格式自动转换

**智能检测：**
- 自动检测分割结果
- 如果关键帧稀疏，自动重试
- 自动插入关键帧
- 无需手动干预

### 7. 视频自动合并器

**功能：** 自动保存视频并在达到数量后合并

**参数：**
- `帧率` - 视频帧率
- `触发合并数量` - 达到此数量后自动合并
- `最终文件名` - 合并后的文件名
- `待合并视频目录` - 临时保存目录
- `最终合并视频目录` - 最终保存目录
- `视频编码` - 编码格式（h264/h265/vp9/prores）
- `视频质量` - CRF 值（越小质量越高）
- `独立运行模式` - 直接合并目录中的视频

**可选输入：**
- `帧序列` - 输入视频帧
- `音频` - 音频数据
- `原音频路径` - 原音频文件路径（优先级最高）

**特点：**
- 自动计数和合并
- 独立运行模式
- 原音频支持
- 格式统一（居中裁剪）
- GPU 加速支持

**独立运行模式：**
- 无需输入帧序列
- 直接合并目录中的视频
- 自动统一格式
- 保留原文件

## 🔧 配置建议

### 推荐配置1：长视频分段处理

```
[视频转换分割器]
- 转换为MP4: ❌ 关闭（让智能检测决定）
- VFR转CFR: ✅ 开启
- 插入关键帧: ❌ 关闭（让智能检测决定）
- 单次运行: ✅ 开启

[视频自动合并器]
- 独立运行模式: ❌ 关闭
- 触发合并数量: 999
- 连接原音频路径: ✅ 推荐
```

### 推荐配置2：批量视频处理

```
[视频目录加载器]
- 加载数量: 10

[视频自动合并器]
- 独立运行模式: ❌ 关闭
- 触发合并数量: 10
- 单次运行: ✅ 开启
```

### 推荐配置3：独立合并视频

```
[视频自动合并器]
- 独立运行模式: ✅ 开启
- 触发合并数量: 10
- 视频编码: h264
- 视频质量: 23
```

## 🎯 常见问题

### Q1: 视频只分割成1个片段？

**A:** 这是关键帧稀疏问题。新版本会自动检测并重试，无需手动操作。

**如果仍有问题：**
1. 手动开启"插入关键帧"
2. 同时开启"转换为MP4"
3. 查看控制台输出

### Q2: 音频和视频不同步？

**A:** 使用原音频路径功能：

```
[视频转换分割器] → 原音频路径 → [视频自动合并器]
```

这样音频保持完整，不会被切割。

### Q3: 处理速度慢？

**A:** 启用 GPU 加速：

1. 安装 NVIDIA 驱动
2. 确保 FFmpeg 支持 NVENC
3. 自动检测并使用 GPU

详见：[GPU加速说明](GPU加速说明.md)

### Q4: 批量处理时重复执行？

**A:** 开启"单次运行"功能：

```
[视频转换分割器]
- 单次运行: ✅ 开启
```

详见：[单次运行功能说明](单次运行功能说明.md)

### Q5: 合并后视频有黑边？

**A:** 新版本使用居中裁剪模式，无黑边。

详见：[裁剪模式对比](裁剪模式对比.md)

### Q6: 帧率从30fps变成29.97fps？

**A:** 开启 VFR转CFR 功能：

```
[视频转换分割器]
- VFR转CFR: ✅ 开启
```

详见：[VFR转CFR功能说明](VFR转CFR功能说明.md)

## 🛠️ 工具使用

### 检查关键帧分布

```bash
python 检查关键帧.py "video.mp4"
```

**输出示例：**
```
总共找到 103 个关键帧 (I帧)

关键帧时间点 (秒):
--------------------------------------------------
  关键帧   1:    0.000 秒
  关键帧   2:   10.000 秒
  关键帧   3:   20.000 秒
  ...

关键帧间隔分析:
--------------------------------------------------
  间隔 1: 10.000 秒
  间隔 2: 10.000 秒
  ...

平均间隔: 10.000 秒
接近10秒的间隔: 100/102
```

### 检查视频帧率

```bash
python 检查视频帧率.py "video.mp4"
```

**输出示例：**
```
视频信息:
- 帧率: 30.00 fps
- 时长: 1031.24 秒
- 分辨率: 1920x1080
- 编码: h264
```

## 📝 更新日志

### v3.0 (最新)

**新增功能：**
- ✅ 智能关键帧检测与自动重试
- ✅ 原音频提取和合并功能
- ✅ 视频自动合并器独立运行模式
- ✅ 居中裁剪模式（无黑边）
- ✅ 音频文件命名优化（0000_audio）
- ✅ 保存元数据功能（默认开启）
- ✅ 浏览目录按钮（所有加载器和保存器节点）

**优化改进：**
- ✅ 自动检测关键帧问题并重试
- ✅ 音频优先级管理
- ✅ 参数顺序优化
- ✅ 独立模式保留原文件
- ✅ 工作流元数据完整保存
- ✅ PNG格式自动切换（保存元数据时）

### v2.x

**核心功能：**
- ✅ GPU 加速支持
- ✅ 单次运行功能
- ✅ VFR转CFR 转换
- ✅ 插入关键帧开关
- ✅ 帧率问题修复
- ✅ 同名文件自动重命名

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📧 联系方式

如有问题或建议，请提交 Issue。

---

**提示：** 建议先阅读 [智能关键帧检测说明](docs/智能关键帧检测说明.md) 和 [原音频处理功能说明](docs/原音频处理功能说明.md) 了解核心功能。
